#!/usr/bin/env bash
set -eo pipefail

# Get the plugin root directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Setup php-build
PHP_BUILD_ROOT="$PLUGIN_DIR/vendor/php-build"
export PATH="$PHP_BUILD_ROOT/bin:$PATH"

# Extract version from ASDF variables
version="${ASDF_INSTALL_VERSION}"
install_path="${ASDF_INSTALL_PATH}"

# Handle "latest" version resolution
if [ "$version" = "latest" ]; then
  version=$("${PLUGIN_DIR}/bin/latest-stable")
  echo "Resolved 'latest' to version $version"
fi

# Pass through custom configure options
if [ -n "$PHP_CONFIGURE_OPTIONS" ]; then
  export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS:-} ${PHP_CONFIGURE_OPTIONS}"
fi

# Pass through PEAR option
if [ "${PHP_WITHOUT_PEAR:-no}" != "no" ]; then
  export PHP_BUILD_CONFIGURE_OPTS="${PHP_BUILD_CONFIGURE_OPTS} --without-pear"
fi

# Pass through concurrency settings
if [ -n "$ASDF_CONCURRENCY" ]; then
  export PHP_BUILD_EXTRA_MAKE_ARGUMENTS="-j${ASDF_CONCURRENCY}"
fi

echo "Building PHP ${version} with php-build..."
echo "Install path: ${install_path}"

# Call php-build to do the heavy lifting
if php-build "$version" "$install_path"; then
  echo "✓ PHP ${version} built successfully"
else
  echo "✗ PHP build failed"
  exit 1
fi

# Install Composer globally (php-build doesn't do this by default)
install_composer() {
  local bin_path="$install_path/bin"

  echo "Installing Composer..."

  local expected_signature
  expected_signature="$(curl -sL https://composer.github.io/installer.sig)"

  $bin_path/php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  $bin_path/php -r "if (hash_file('sha384', 'composer-setup.php') === '${expected_signature}') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); exit(1); } echo PHP_EOL;"
  $bin_path/php composer-setup.php --install-dir="$bin_path" --filename=composer
  $bin_path/php -r "unlink('composer-setup.php');"

  echo "✓ Composer installed successfully"
}

# Install Composer
if install_composer; then
  echo "✓ PHP ${version} installation complete!"
else
  echo "⚠ Composer installation failed, but PHP was installed successfully"
fi

# Create conf.d directory for user configuration
mkdir -p "$install_path/conf.d"
if [ ! -f "$install_path/conf.d/php.ini" ]; then
  echo "# Add custom PHP configuration here" > "$install_path/conf.d/php.ini"
fi

echo ""
echo "Installation complete!"
echo "PHP installed at: $install_path"
echo "Add custom PHP settings to: $install_path/conf.d/php.ini"
